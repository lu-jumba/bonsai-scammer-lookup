'use strict';

var addressing = require('@mailchain/addressing');
var isEqual = require('lodash/isEqual');

/** Create {@link AddressIdentityKeyResolver} that resolved identity keys by using the Mailchain API.  */
function createMailchainApiAddressIdentityKeyResolver(identityKeys) {
    return (address) => identityKeys.getAddressIdentityKey(address);
}
/** Create {@link AddressIdentityKeyResolver} that resolves by using mappings of address->IdentityKey that is part of {@link ParseMimeTextResult} with the `X-IdentityKeys` header.  */
function createMessageHeaderIdentityKeyResolver(addressIdentityKeys) {
    return async (address) => {
        const entry = addressIdentityKeys.get(addressing.formatAddress(address, 'mail'));
        if (entry == null)
            return null;
        try {
            const actualAddressBytes = addressing.decodeAddressByProtocol(address.username, entry.protocol).decoded;
            const expectedAddressBytes = await addressing.addressFromPublicKey(entry.identityKey, entry.protocol);
            if (isEqual(expectedAddressBytes, actualAddressBytes))
                return entry;
        }
        catch (e) {
            // failed processing address, ignore it and don't return the key
        }
        return null;
    };
}

exports.createMailchainApiAddressIdentityKeyResolver = createMailchainApiAddressIdentityKeyResolver;
exports.createMessageHeaderIdentityKeyResolver = createMessageHeaderIdentityKeyResolver;
