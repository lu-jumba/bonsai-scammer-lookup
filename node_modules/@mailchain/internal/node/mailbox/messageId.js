'use strict';

var crypto = require('@mailchain/crypto');
var encoding = require('@mailchain/encoding');
var sha3 = require('@noble/hashes/sha3');

function createMailchainMessageIdCreator(keyRing) {
    return async (params) => {
        const typeBytes = encoding.decodeUtf8(params.type);
        const mailIdBytes = encoding.decodeUtf8(params.mailData.id);
        const mailboxBytes = params.type === 'received' ? crypto.publicKeyToBytes(params.mailbox) : new Uint8Array();
        const ownerBytes = params.type === 'received' ? encoding.decodeUtf8(params.owner) : new Uint8Array();
        return encoding.encodeHex(sha3.sha3_256(await keyRing
            .rootInboxKey()
            .sign(Uint8Array.from([...typeBytes, ...mailIdBytes, ...mailboxBytes, ...ownerBytes]))));
    };
}

exports.createMailchainMessageIdCreator = createMailchainMessageIdCreator;
